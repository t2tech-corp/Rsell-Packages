#' Submit Poshmark Sales Activity to Database
#'
#' This function Submits the Poshmark Sales Activity to Database.
#'
#' Requires: dplyr
#'
#' @param sales_activity Poshmark Sales Activity Report
#' @return sales_activity Poshmark Sales Activity Report with added Duplicate column
#' @export
#'

PM_Sales_Upload_Submit <- function(sales_activity) {

    ####  Fetch Previous Sales -------------------------------------------------------------------------------------------------- ####
    ##                                                                                                                              ##

    prev_order_list <- pm_sales$order_id

    ##                                                                                                                              ##
    #### ------------------------------------------------------------------------------------------------------------------------ ####


    ####  Process First Time Upload and Return ---------------------------------------------------------------------------------- ####
    ##                                                                                                                              ##

    if(length(prev_order_list) == 0) {

        ####  Append Data to Table ---------------------------------------------------------------------------------------------- ####
        ##                                                                                                                          ##

        sales_activity$date_add_db <- as.character(Sys.time())

        DB_Append_Table(pm_sales_name, sales_activity)

        pm_sales <<- bind_rows(pm_sales, sales_activity)

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####


        ####  Add Duplicate Flag ------------------------------------------------------------------------------------------------ ####
        ##                                                                                                                          ##

        sales_activity <- sales_activity %>% mutate(duplicate = FALSE)

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####


        ####  Return Modified Table --------------------------------------------------------------------------------------------- ####
        ##                                                                                                                          ##

        return(sales_activity)

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####

    }

    ##                                                                                                                              ##
    #### ------------------------------------------------------------------------------------------------------------------------ ####


    ####  Process Previous User ------------------------------------------------------------------------------------------------- ####
    ##                                                                                                                              ##

    if(length(prev_order_list) > 0) {

        ####  Remove Duplicates ------------------------------------------------------------------------------------------------- ####
        ##                                                                                                                          ##

        f_sales_activity <- sales_activity %>% filter(!order_id %in% prev_order_list)

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####


        ####  Process New Sales Activity ---------------------------------------------------------------------------------------- ####
        ##                                                                                                                          ##

        if(nrow(f_sales_activity) > 0) {

            f_sales_activity$date_add_db <- as.character(Sys.time())

            DB_Append_Table(pm_sales_name, f_sales_activity)

            pm_sales <<- bind_rows(pm_sales, f_sales_activity)

            pm_sales <<- PM_Sales_Table_Sort(pm_sales)

        }

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####


        ####  Add Duplicate Flag ------------------------------------------------------------------------------------------------ ####
        ##                                                                                                                          ##

        sales_activity <- sales_activity %>%
                          mutate(duplicate = case_when(order_id %in% prev_order_list ~ TRUE,
                                                       TRUE ~ FALSE))

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####


        ####  Return Modified Table --------------------------------------------------------------------------------------------- ####
        ##                                                                                                                          ##

        return(sales_activity)

        ##                                                                                                                          ##
        #### -------------------------------------------------------------------------------------------------------------------- ####

    }

    ##                                                                                                                              ##
    #### ------------------------------------------------------------------------------------------------------------------------ ####

}
